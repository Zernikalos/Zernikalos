name: Zernikalos Next Release

on:
  workflow_dispatch:

permissions:
  packages: write
  contents: read
  actions: read

jobs:
  publish-next:
    name: Publish Next Release
    runs-on: ubuntu-latest
    # Skip if commit message starts with "release:" (release commits have this format)
    # if: ${{ !startsWith(github.event.head_commit.message, 'release:') }}
    env:
      GITHUB_TOKEN: ${{ github.token }}
      GITHUB_ACTOR: ${{ github.actor }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Build Environment
        uses: ./.github/actions/setup-build-env

      - name: Generate Next Version
        id: version
        run: |
          BASE_VERSION=$(cat VERSION.txt)
          COMMIT_HASH=$(git rev-parse --short HEAD)
          MAVEN_VERSION="${BASE_VERSION}-SNAPSHOT"
          NPM_VERSION="${BASE_VERSION}-next.${COMMIT_HASH}"
          echo "maven_version=$MAVEN_VERSION" >> $GITHUB_OUTPUT
          echo "npm_version=$NPM_VERSION" >> $GITHUB_OUTPUT
          echo "Publishing Maven version: $MAVEN_VERSION"
          echo "Publishing npm version: $NPM_VERSION"

      - name: Verify Version Configuration
        run: ./gradlew printVersion -Pversion=${{ steps.version.outputs.maven_version }}

      - name: Build
        run: ./gradlew build -Pversion=${{ steps.version.outputs.maven_version }}

      - name: Publish to Maven Repository
        run: ./gradlew publishAllPublicationsToMavenRepository -Pversion=${{ steps.version.outputs.maven_version }} -Puser=$GITHUB_ACTOR -Paccess_token=$GITHUB_TOKEN

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@zernikalos'

      - name: Publish JS Package
        working-directory: build/js
        run: |
          npm version ${{ steps.version.outputs.npm_version }} --no-git-tag-version
          npm publish --workspace=@zernikalos/zernikalos --tag next
        env:
          NODE_AUTH_TOKEN: ${{ github.token }}
