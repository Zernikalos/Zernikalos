name: Zernikalos Next Release

on:
  push:
    branches: [ main ]
    tags-ignore: [ 'v*.*.*' ]
  workflow_dispatch:

permissions:
  packages: write
  contents: read
  actions: read

jobs:
  publish-next:
    name: Publish Next Release
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ github.token }}
      GITHUB_ACTOR: ${{ github.actor }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Build Environment
        uses: ./.github/actions/setup-build-env

      - name: Generate Next Version
        id: version
        run: |
          BASE_VERSION=$(cat VERSION.txt)
          COMMIT_HASH=$(git rev-parse --short HEAD)
          NEXT_VERSION="${BASE_VERSION}-next.${COMMIT_HASH}"
          echo "version=$NEXT_VERSION" >> $GITHUB_OUTPUT
          echo "Publishing next version: $NEXT_VERSION"

      - name: Verify Version Configuration
        run: ./gradlew printVersion -Pversion=${{ steps.version.outputs.version }}

      - name: Build
        run: ./gradlew build -Pversion=${{ steps.version.outputs.version }}

      - name: Publish to Maven Repository
        run: ./gradlew publishAllPublicationsToMavenRepository -Pversion=${{ steps.version.outputs.version }} -Puser=$GITHUB_ACTOR -Paccess_token=$GITHUB_TOKEN

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@zernikalos'

      - name: Publish JS Package
        working-directory: build/js
        run: npm publish --workspace=@zernikalos/zernikalos --tag next
        env:
          NODE_AUTH_TOKEN: ${{ github.token }}

